sudo: required

services:
 - docker

addons:
  apt:
    packages:
      - docker-ce=18.03* #Needed for experimental CLI (manifest)

language: bash

env:
  matrix:
  # TARGET_IMG  = Base image architecture to be used for alpine
  # TARGET_ARCH = qemu binary to be downloaded from https://github.com/multiarch/qemu-user-static/releases
  - TARGET_IMG=amd64   
  - TARGET_IMG=arm64v8 DOCKER_ARCH=arm64 QEMU_ARCH=aarch64
  - TARGET_IMG=arm32v6 DOCKER_ARCH=arm   QEMU_ARCH=arm

script:
- BUILD=true PUSH=false ./build.sh
- |
  # maybe depending on the $TRAVIS_BRANCH I can build master or devel branches
  if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then
    # Push image
    docker login -u="$DOCKER_USER" -p="$DOCKER_PASS"
    BUILD=false PUSH=true ./build.sh
  fi

jobs:
  include:
  - stage: Manifest
    script:
    - |
      mkdir -p $HOME/.docker
      echo '{"experimental": "enabled"}'>$HOME/.docker/config.json
    - docker login -u="$DOCKER_USER" -p="$DOCKER_PASS"
    - |
      if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then
        ARCHS="arm amd64 arm64" BUILD=false PUSH=false MANIFEST=true ./build.sh
      fi
    env:
